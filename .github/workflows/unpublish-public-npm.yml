name: Unpublish from Public NPM

on:
    workflow_dispatch:
        inputs:
            package:
                description: "Package to unpublish"
                required: true
                type: choice
                options:
                    - core
                    - react
                    - both
            version:
                description: "Version to unpublish (e.g., 1.0.0-beta.1)"
                required: true
                type: string
            confirm:
                description: 'Type "UNPUBLISH" to confirm deletion'
                required: true
                type: string

jobs:
    unpublish:
        name: Unpublish Package
        runs-on: ubuntu-22.04-2cpu-8ram-75ssd

        steps:
            - name: Validate confirmation
              run: |
                  if [ "${{ github.event.inputs.confirm }}" != "UNPUBLISH" ]; then
                    echo "âŒ Confirmation failed. You must type 'UNPUBLISH' to proceed."
                    exit 1
                  fi
                  echo "âœ… Confirmation validated"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"

            - name: Unpublish Core package
              if: github.event.inputs.package == 'both' || github.event.inputs.package == 'core'
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  echo "ðŸ—‘ï¸ Unpublishing @auth0/web-ui-components-core@${{ github.event.inputs.version }}..."

                  if npm unpublish @auth0/web-ui-components-core@${{ github.event.inputs.version }} --registry https://registry.npmjs.org; then
                    echo "âœ… Successfully unpublished @auth0/web-ui-components-core@${{ github.event.inputs.version }}"
                    echo "core_unpublished=true" >> $GITHUB_OUTPUT
                  else
                    echo "âŒ Failed to unpublish @auth0/web-ui-components-core@${{ github.event.inputs.version }}"
                    echo "ðŸ’¡ Note: Packages can only be unpublished within 72 hours of publication"
                    echo "ðŸ’¡ After 72 hours, use deprecation instead"
                    exit 1
                  fi

            - name: Unpublish React package
              if: github.event.inputs.package == 'both' || github.event.inputs.package == 'react'
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  echo "ðŸ—‘ï¸ Unpublishing @auth0/web-ui-components-react@${{ github.event.inputs.version }}..."

                  if npm unpublish @auth0/web-ui-components-react@${{ github.event.inputs.version }} --registry https://registry.npmjs.org; then
                    echo "âœ… Successfully unpublished @auth0/web-ui-components-react@${{ github.event.inputs.version }}"
                    echo "react_unpublished=true" >> $GITHUB_OUTPUT
                  else
                    echo "âŒ Failed to unpublish @auth0/web-ui-components-react@${{ github.event.inputs.version }}"
                    echo "ðŸ’¡ Note: Packages can only be unpublished within 72 hours of publication"
                    echo "ðŸ’¡ After 72 hours, use deprecation instead"
                    exit 1
                  fi

            - name: Generate Summary
              if: always()
              run: |
                  echo "## ðŸ—‘ï¸ NPM Unpublish Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Action:** Unpublish packages from public npm" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** \`${{ github.event.inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "### Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ github.event.inputs.package }}" = "both" ] || [ "${{ github.event.inputs.package }}" = "core" ]; then
                    echo "- ðŸ“¦ **@auth0/web-ui-components-core@${{ github.event.inputs.version }}**" >> $GITHUB_STEP_SUMMARY
                    if [ "${{ steps.unpublish-core.outcome }}" = "success" ]; then
                      echo "  - Status: âœ… Unpublished" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "  - Status: âŒ Failed" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi

                  if [ "${{ github.event.inputs.package }}" = "both" ] || [ "${{ github.event.inputs.package }}" = "react" ]; then
                    echo "- ðŸ“¦ **@auth0/web-ui-components-react@${{ github.event.inputs.version }}**" >> $GITHUB_STEP_SUMMARY
                    if [ "${{ steps.unpublish-react.outcome }}" = "success" ]; then
                      echo "  - Status: âœ… Unpublished" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "  - Status: âŒ Failed" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âš ï¸ **Important Notes:**" >> $GITHUB_STEP_SUMMARY
                  echo "- Packages can only be unpublished within **72 hours** of publication" >> $GITHUB_STEP_SUMMARY
                  echo "- After 72 hours, you can only **deprecate** the package" >> $GITHUB_STEP_SUMMARY
                  echo "- Unpublished versions cannot be republished with the same version number" >> $GITHUB_STEP_SUMMARY
