name: Publish NPM Packages

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (comma-separated, e.g., core,react or "all")'
        required: false
        default: "all"
        type: string
      core_version:
        description: "Version for @auth0-web-ui-components/core (e.g., 1.2.3, 1.0.0-beta.1). If empty, uses version from package.json"
        required: false
        type: string
      react_version:
        description: "Version for @auth0-web-ui-components/react (e.g., 0.2.0, 0.1.0-beta.1). If empty, uses version from package.json"
        required: false
        type: string
      dry_run:
        description: "Dry run (skip actual publishing)"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on:
      labels: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write # to be able to clone the repo and commit version updates
      id-token: write # to enable use of OIDC for npm provenance

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup JFrog CLI
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@f0a84f35b0e0bd21838c5fb3e6788072d6540d13 # v4.6.0 at 2025-01-02
        env:
          JF_URL: https://a0us.jfrog.io
        with:
          oidc-provider-name: atko-cic

      - name: Setup NPM Authentication
        env:
          ARTIFACTORY_USER: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          ARTIFACTORY_API_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}
        run: |
          curl -u $ARTIFACTORY_USER:$ARTIFACTORY_API_TOKEN https://a0us.jfrog.io/artifactory/api/npm/npm/auth/a0 > ~/.npmrc
          echo "registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc
          echo "@auth0-web-ui-components:registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Auto-bump versions for manual dispatch
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.core_version == '' && github.event.inputs.react_version == ''
        run: |
          echo "Auto-bumping versions for manual workflow run"

          # Function to bump patch version
          bump_patch_version() {
            local pkg_dir=$1
            local pkg_name=$2
            
            cd "$pkg_dir"
            current=$(node -p "require('./package.json').version")
            echo "Current $pkg_name version: $current"
            
            # Bump patch version
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            
            echo "Bumped $pkg_name: $current -> $new_version"
            cd - > /dev/null
          }

          # Bump both packages
          if [ -d "./packages/core" ]; then
            bump_patch_version "./packages/core" "@auth0-web-ui-components/core"
          fi

          if [ -d "./packages/react" ]; then
            bump_patch_version "./packages/react" "@auth0-web-ui-components/react"
          fi

      - name: Update package versions
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -e
          echo "Auto-bumping versions for main branch push"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          UPDATED_PACKAGES=()

          bump_package_version() {
            local pkg_dir=$1
            local pkg_name=$2
            
            cd "$pkg_dir"
            current=$(node -p "require('./package.json').version")
            echo "Current $pkg_name version: $current"
            
            # Bump minor version by default for main branch merges
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor + 1}.0\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            
            echo "Bumped $pkg_name: $current -> $new_version"
            UPDATED_PACKAGES+=("$pkg_name@$new_version")
            
            cd - > /dev/null
            echo "$new_version"
          }

          # Check what packages have changes
          core_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/core/" || true)
          react_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/react/" || true)

          # Bump core package if it has changes
          if [ -n "$core_changes" ] && [ -d "./packages/core" ]; then
            echo "Detected changes in core package"
            CORE_VERSION=$(bump_package_version "./packages/core" "@auth0-web-ui-components/core")
            echo "CORE_VERSION=$CORE_VERSION" >> $GITHUB_ENV
          fi

          # Bump react package if it has changes  
          if [ -n "$react_changes" ] && [ -d "./packages/react" ]; then
            echo "Detected changes in react package"
            REACT_VERSION=$(bump_package_version "./packages/react" "@auth0-web-ui-components/react")
            echo "REACT_VERSION=$REACT_VERSION" >> $GITHUB_ENV
          fi

          # Commit version bumps back to main
          if [ ${#UPDATED_PACKAGES[@]} -gt 0 ]; then
            git add packages/*/package.json
            
            commit_msg="chore: bump package versions"$'\n\n'
            for pkg in "${UPDATED_PACKAGES[@]}"; do
              commit_msg="$commit_msg- $pkg"$'\n'
            done
            
            git commit -m "$commit_msg"
            git push origin main
            
            echo "VERSIONS_UPDATED=true" >> $GITHUB_ENV
            echo "Committed version updates to main"
          else
            echo "VERSIONS_UPDATED=false" >> $GITHUB_ENV
            echo "No package changes detected"
          fi

      - name: Manual version updates
        if: github.event.inputs.core_version != '' || github.event.inputs.react_version != '' || github.event.inputs.semverBump != ''
        run: |
          echo "Processing manual version updates..."

          update_package_version() {
            local pkg_dir=$1
            local version=$2
            local bump_type=$3
            
            cd "$pkg_dir"
            if [ -n "$version" ]; then
              # Set specific version
              node -e "
                const pkg = require('./package.json');
                pkg.version = '$version';
                require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              "
              echo "$version"
            else
              # Bump version using semver
              node -e "
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                let newVersion;
                switch ('$bump_type') {
                  case 'major': newVersion = \`\${major + 1}.0.0\`; break;
                  case 'minor': newVersion = \`\${major}.\${minor + 1}.0\`; break;
                  case 'patch': newVersion = \`\${major}.\${minor}.\${patch + 1}\`; break;
                  default: newVersion = \`\${major}.\${minor + 1}.0\`; break;
                }
                pkg.version = newVersion;
                require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log(newVersion);
              "
            fi
            cd - > /dev/null
          }

          SEMVER_BUMP="${{ github.event.inputs.semverBump || 'minor' }}"

          # Handle core package
          if [ -n "${{ github.event.inputs.core_version }}" ]; then
            CORE_VERSION="${{ github.event.inputs.core_version }}"
            echo "CORE_VERSION=$CORE_VERSION" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.packages }}" == *"core"* ]] || [ "${{ github.event.inputs.packages }}" = "all" ]; then
            if [ -d "./packages/core" ]; then
              CORE_VERSION=$(update_package_version "./packages/core" "" "$SEMVER_BUMP")
              echo "CORE_VERSION=$CORE_VERSION" >> $GITHUB_ENV
            fi
          fi

          # Handle react package
          if [ -n "${{ github.event.inputs.react_version }}" ]; then
            REACT_VERSION="${{ github.event.inputs.react_version }}"
            echo "REACT_VERSION=$REACT_VERSION" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.packages }}" == *"react"* ]] || [ "${{ github.event.inputs.packages }}" = "all" ]; then
            if [ -d "./packages/react" ]; then
              REACT_VERSION=$(update_package_version "./packages/react" "" "$SEMVER_BUMP")
              echo "REACT_VERSION=$REACT_VERSION" >> $GITHUB_ENV
            fi
          fi

      - name: Determine packages to publish
        id: packages
        run: |
          if [ "${{ github.event.inputs.packages }}" = "all" ] || [ -z "${{ github.event.inputs.packages }}" ]; then
            echo "packages=core,react" >> $GITHUB_OUTPUT
          else
            echo "packages=${{ github.event.inputs.packages }}" >> $GITHUB_OUTPUT
          fi

      - name: Publish Core package
        if: contains(steps.packages.outputs.packages, 'core')
        working-directory: ./packages/core
        run: |
          echo "Publishing @auth0-web-ui-components/core..."
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Would publish @auth0-web-ui-components/core"
            pnpm publish --dry-run --access public --no-git-checks
          else
            pnpm publish --access public --no-git-checks
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Publish React package
        if: contains(steps.packages.outputs.packages, 'react')
        working-directory: ./packages/react
        run: |
          echo "Publishing @auth0-web-ui-components/react..."
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Would publish @auth0-web-ui-components/react"
            pnpm publish --dry-run --access public --no-git-checks
          else
            pnpm publish --access public --no-git-checks
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Commit version updates
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.core_version == '' && github.event.inputs.react_version == ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if there are any changes to commit
          if git diff --quiet packages/*/package.json; then
            echo "No version changes to commit"
          else
            echo "Committing version updates..."
            git add packages/*/package.json
            
            # Create commit message with updated versions
            CORE_VERSION=""
            REACT_VERSION=""
            
            if [ -f "./packages/core/package.json" ]; then
              CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
            fi
            
            if [ -f "./packages/react/package.json" ]; then
              REACT_VERSION=$(node -p "require('./packages/react/package.json').version")
            fi
            
            commit_msg="chore: auto-bump package versions after publish"$'\n\n'
            if [ -n "$CORE_VERSION" ]; then
              commit_msg="$commit_msg- @auth0-web-ui-components/core@$CORE_VERSION"$'\n'
            fi
            if [ -n "$REACT_VERSION" ]; then
              commit_msg="$commit_msg- @auth0-web-ui-components/react@$REACT_VERSION"$'\n'
            fi
            
            git commit -m "$commit_msg"
            git push origin HEAD
            
            echo "âœ… Version updates committed and pushed to repository"
          fi

      - name: Summary
        run: |
          echo "## ðŸ“¦ NPM Packages Published" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.packages.outputs.packages }}" == *"core"* ]]; then
            if [ -f "./packages/core/package.json" ]; then
              CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
              echo "- âœ… @auth0-web-ui-components/core@$CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              if [ -n "${{ github.event.inputs.core_version }}" ]; then
                echo "- âœ… @auth0-web-ui-components/core@${{ github.event.inputs.core_version }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… @auth0-web-ui-components/core" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

          if [[ "${{ steps.packages.outputs.packages }}" == *"react"* ]]; then
            if [ -f "./packages/react/package.json" ]; then
              REACT_VERSION=$(node -p "require('./packages/react/package.json').version")
              echo "- âœ… @auth0-web-ui-components/react@$REACT_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              if [ -n "${{ github.event.inputs.react_version }}" ]; then
                echo "- âœ… @auth0-web-ui-components/react@${{ github.event.inputs.react_version }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… @auth0-web-ui-components/react" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Packages published to JFrog Artifactory: https://a0us.jfrog.io" >> $GITHUB_STEP_SUMMARY
