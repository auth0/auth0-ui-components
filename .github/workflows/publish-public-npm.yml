name: Publish to Public NPM

on:
  workflow_dispatch:
    inputs:
      core_version:
        description: "Core package version (e.g., 1.0.0-beta.1, 1.0.0, 1.1.0-alpha.0)"
        required: false
        type: string
      react_version:
        description: "React package version (e.g., 1.0.0-beta.1, 1.0.0, 1.1.0-alpha.0)"
        required: false
        type: string
      packages:
        description: "Packages to publish"
        required: true
        type: choice
        default: "both"
        options:
          - "both"
          - "core"
          - "react"
      npm_tag:
        description: "NPM dist-tag (latest, beta, alpha, next)"
        required: true
        type: choice
        default: "beta"
        options:
          - "latest"
          - "beta"
          - "alpha"
          - "next"
      dry_run:
        description: "Dry run (preview without publishing)"
        required: false
        type: boolean
        default: true

jobs:
  publish:
    name: Build & Publish to Public NPM
    runs-on: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Build packages
        run: |
          echo "ğŸ”¨ Building packages..."
          pnpm run build
          echo "âœ… Packages built successfully"

      - name: Update Core package for public npm
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'core') &&
          github.event.inputs.core_version != ''
        working-directory: ./packages/core
        run: |
          echo "ğŸ·ï¸ Updating @auth0/web-ui-components-core package.json for public npm..."

          node -e "
            const pkg = require('./package.json');
            pkg.name = '@auth0/web-ui-components-core';
            pkg.version = '${{ github.event.inputs.core_version }}';
            
            // Add publishConfig for public npm
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "âœ… Updated @auth0/web-ui-components-core to version ${{ github.event.inputs.core_version }}"

      - name: Update React package for public npm
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'react') &&
          github.event.inputs.react_version != ''
        working-directory: ./packages/react
        run: |
          echo "ğŸ·ï¸ Updating @auth0/web-ui-components-react package.json for public npm..."

          node -e "
            const pkg = require('./package.json');
            pkg.name = '@auth0/web-ui-components-react';
            pkg.version = '${{ github.event.inputs.react_version }}';
            
            // Add publishConfig for public npm
            pkg.publishConfig = {
              access: 'public',
              registry: 'https://registry.npmjs.org/'
            };
            
            // Update workspace dependency if it exists
            if (pkg.dependencies && pkg.dependencies['@auth0-web-ui-components/core']) {
              // Replace workspace protocol with actual version
              pkg.dependencies['@auth0/web-ui-components-core'] = '${{ github.event.inputs.core_version }}';
              delete pkg.dependencies['@auth0-web-ui-components/core'];
            }
            
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          echo "âœ… Updated @auth0/web-ui-components-react to version ${{ github.event.inputs.react_version }}"

      - name: Publish Core package to public npm
        id: publish-core
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'core') &&
          github.event.inputs.core_version != ''
        working-directory: ./packages/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ Publishing @auth0/web-ui-components-core@$current_version to public npm..."

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” DRY RUN MODE - Skipping actual publish"
            pnpm publish --dry-run --no-git-checks --tag ${{ github.event.inputs.npm_tag }}
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "âœ… Dry run completed for @auth0/web-ui-components-core@$current_version"
          else
            pnpm publish --no-git-checks --tag ${{ github.event.inputs.npm_tag }}
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "âœ… Successfully published @auth0/web-ui-components-core@$current_version"
          fi

      - name: Publish React package to public npm
        id: publish-react
        if: |
          (github.event.inputs.packages == 'both' || github.event.inputs.packages == 'react') &&
          github.event.inputs.react_version != ''
        working-directory: ./packages/react
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ Publishing @auth0/web-ui-components-react@$current_version to public npm..."

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” DRY RUN MODE - Skipping actual publish"
            pnpm publish --dry-run --no-git-checks --tag ${{ github.event.inputs.npm_tag }}
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "âœ… Dry run completed for @auth0/web-ui-components-react@$current_version"
          else
            pnpm publish --no-git-checks --tag ${{ github.event.inputs.npm_tag }}
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "âœ… Successfully published @auth0/web-ui-components-react@$current_version"
          fi

      - name: Generate Summary
        run: |
          echo "## ğŸ“¦ Public NPM Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "### ğŸ” DRY RUN MODE" >> $GITHUB_STEP_SUMMARY
            echo "No packages were actually published. This was a test run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "core" ]; then
            if [ -n "${{ github.event.inputs.core_version }}" ]; then
              echo "- ğŸ“¦ \`@auth0/web-ui-components-core@${{ github.event.inputs.core_version }}\`" >> $GITHUB_STEP_SUMMARY
              echo "  - Tag: \`${{ github.event.inputs.npm_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
              echo "  - Install: \`npm install @auth0/web-ui-components-core@${{ github.event.inputs.npm_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "react" ]; then
            if [ -n "${{ github.event.inputs.react_version }}" ]; then
              echo "- ğŸ“¦ \`@auth0/web-ui-components-react@${{ github.event.inputs.react_version }}\`" >> $GITHUB_STEP_SUMMARY
              echo "  - Tag: \`${{ github.event.inputs.npm_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "  - Registry: https://registry.npmjs.org" >> $GITHUB_STEP_SUMMARY
              echo "  - Install: \`npm install @auth0/web-ui-components-react@${{ github.event.inputs.npm_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "core" ]; then
            if [ -n "${{ github.event.inputs.core_version }}" ]; then
              echo "- [View @auth0/web-ui-components-core on npm](https://www.npmjs.com/package/@auth0/web-ui-components-core)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "react" ]; then
            if [ -n "${{ github.event.inputs.react_version }}" ]; then
              echo "- [View @auth0/web-ui-components-react on npm](https://www.npmjs.com/package/@auth0/web-ui-components-react)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Your internal JFrog registry continues to use \`@auth0-web-ui-components/*\` packages unchanged." >> $GITHUB_STEP_SUMMARY

      - name: Create Git tags
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "ğŸ·ï¸ Creating Git tags for published packages..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Tag core package
          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "core" ]; then
            if [ -n "${{ github.event.inputs.core_version }}" ]; then
              TAG_NAME="@auth0/core@${{ github.event.inputs.core_version }}"
              git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-core@${{ github.event.inputs.core_version }}"
              git push origin "$TAG_NAME"
              echo "âœ… Created and pushed tag: $TAG_NAME"
            fi
          fi

          # Tag react package
          if [ "${{ github.event.inputs.packages }}" = "both" ] || [ "${{ github.event.inputs.packages }}" = "react" ]; then
            if [ -n "${{ github.event.inputs.react_version }}" ]; then
              TAG_NAME="@auth0/react@${{ github.event.inputs.react_version }}"
              git tag -a "$TAG_NAME" -m "Release @auth0/web-ui-components-react@${{ github.event.inputs.react_version }}"
              git push origin "$TAG_NAME"
              echo "âœ… Created and pushed tag: $TAG_NAME"
            fi
          fi

          echo "ğŸ‰ All tags created successfully!"

      - name: Restore package.json files
        if: always()
        run: |
          echo "ğŸ”„ Restoring original package.json files..."
          git checkout packages/core/package.json packages/react/package.json || true
          echo "âœ… Package files restored"
